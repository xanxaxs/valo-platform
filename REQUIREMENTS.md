# Valorant Tracker - 要件定義書

## 1. プロジェクト概要

### 1.1 目的
Valorantの試合データとボイスチャット（VC）を統合的にトラッキング・分析し、チームのパフォーマンス向上を支援するシステム。

### 1.2 背景
- **comms_tracker**: 音声認識・AI評価によるコミュニケーション分析ツール
- **tracker**: Valorant API連携によるマッチトラッキング・統計ツール

これら2つのツールを統合し、マッチイベントとVCを同期させることで、より深い分析を可能にする。

### 1.3 ターゲットユーザー
- Valorantの競技チーム
- チームコーチ
- 分析担当者

---

## 2. 機能要件

### 2.1 マッチトラッキング（trackerから移植）

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| MT-001 | Valorant API接続 | ローカルValorantクライアントとの接続・認証 | 高 |
| MT-002 | ゲーム状態監視 | MENUS/PREGAME/INGAME状態の検出 | 高 |
| MT-003 | マッチ自動検出 | カスタムマッチの開始・終了を自動検出 | 高 |
| MT-004 | プレイヤー情報取得 | 参加プレイヤーのPUUID、エージェント、チーム情報 | 高 |
| MT-005 | キルイベント記録 | キル発生時の座標、時間、武器、関係者を記録 | 高 |
| MT-006 | ラウンド結果記録 | 各ラウンドの勝敗、勝利条件、経済状況 | 高 |
| MT-007 | マッチ詳細保存 | マッチ終了後にAPIから詳細データを取得・保存 | 高 |

### 2.2 ボイスチャット録音・分析（comms_trackerから移植）

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| VC-001 | 音声録音 | システム音声（Discord等）の録音 | 高 |
| VC-002 | 音声認識 | Faster-Whisperによる日本語音声認識 | 高 |
| VC-003 | Valorant用語最適化 | エージェント名、スキル名、コールアウトの認識精度向上 | 中 |
| VC-004 | 話者識別 | Pyannoteによるプレイヤーの声の識別 | 中 |
| VC-005 | 感情分析 | コール時の感情（冷静/パニック等）の分類 | 低 |
| VC-006 | 有用性評価 | コールアウトの有用性をスコアリング | 低 |

### 2.3 マッチ-VC同期システム（新規機能）

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| SYNC-001 | 同期録音開始 | マッチ開始検知と同時に音声録音を自動開始 | 高 |
| SYNC-002 | 同期録音停止 | マッチ終了検知と同時に音声録音を自動停止 | 高 |
| SYNC-003 | ラウンド分割 | ラウンド単位で音声ファイルを分割保存 | 高 |
| SYNC-004 | タイムスタンプ同期 | マッチ開始時刻を基準とした統一タイムライン | 高 |
| SYNC-005 | イベント-音声紐付け | キル/設置/解除イベントと該当時間の音声をリンク | 高 |
| SYNC-006 | 音声セグメント検索 | 特定イベント前後のVCを抽出・再生 | 中 |

### 2.4 統計・分析機能

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| STAT-001 | プレイヤー統計 | KDA、ACS、ダメージ等の基本統計 | 高 |
| STAT-002 | マップ別統計 | マップごとの勝率、統計 | 中 |
| STAT-003 | エージェント別統計 | エージェントごとの統計 | 中 |
| STAT-004 | 時間帯別キル統計 | ラウンド開始からの時間帯別のキル/デス傾向 | 中 |
| STAT-005 | コミュニケーション統計 | コール頻度、有用性スコアの集計 | 中 |

### 2.5 チーム管理機能

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| TEAM-001 | チーム作成 | チーム名、タグの登録 | 中 |
| TEAM-002 | メンバー管理 | メンバーのPUUID、役割の登録 | 中 |
| TEAM-003 | スクリム自動検出 | チームメンバーが揃っているマッチを自動検出 | 中 |

### 2.6 2Dリプレイ機能

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| REPLAY-001 | マップ表示 | 2Dマップ上にプレイヤー位置を表示 | 高 |
| REPLAY-002 | タイムライン再生 | イベントスナップショットの時系列再生 | 高 |
| REPLAY-003 | イベントマーカー | キル、設置、解除のタイムラインマーカー表示 | 高 |
| REPLAY-004 | VC同期再生 | タイムラインに同期した音声再生 | 高 |
| REPLAY-005 | イベントジャンプ | イベントクリックで該当時点にジャンプ | 中 |
| REPLAY-006 | VC転写表示 | 再生中の音声のトランスクリプト表示 | 中 |
| REPLAY-007 | クリップエクスポート | 特定区間の動画/音声エクスポート | 低 |

### 2.7 AI評価機能（comms_trackerから移植）

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| AI-001 | ラウンド評価 | AIによるラウンドごとのコミュニケーション評価 | 中 |
| AI-002 | 改善提案 | 具体的な改善ポイントの提示 | 中 |
| AI-003 | ハイライト抽出 | 良いコールアウトの自動抽出 | 低 |
| AI-004 | RAGナレッジ | 戦術知識ベースを活用した評価 | 低 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| 項目 | 要件 |
|------|------|
| 録音遅延 | マッチ開始から録音開始まで1秒以内 |
| イベント記録 | イベント発生から記録まで100ms以内 |
| リプレイ再生 | シークからの再生開始まで500ms以内 |
| 音声認識 | リアルタイムファクター < 0.5（録音の2倍速で処理） |

### 3.2 信頼性

| 項目 | 要件 |
|------|------|
| データ永続性 | マッチデータは明示的削除まで保持 |
| 録音信頼性 | 録音失敗時の自動リトライ、エラー通知 |
| API断絶対応 | Valorant API切断時の自動再接続 |

### 3.3 拡張性

| 項目 | 要件 |
|------|------|
| KPI統合 | 将来的にKPIアプリへの統合を想定した設計 |
| プラグイン | 統計・分析機能の追加が容易な構造 |
| UI置換 | Streamlit → React への移行を考慮 |

### 3.4 互換性

| 項目 | 要件 |
|------|------|
| OS | Windows 10/11 |
| Python | 3.10以上 |
| Valorant | 最新版に追従 |

---

## 4. システム構成

### 4.1 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                     Valorant Tracker                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │   Valorant   │    │   Discord/   │    │    User      │      │
│  │   Client     │    │   Audio      │    │    Input     │      │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘      │
│         │                   │                   │               │
│         ▼                   ▼                   ▼               │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                    Core Layer                         │      │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐      │      │
│  │  │ Valorant   │  │   Audio    │  │    CLI     │      │      │
│  │  │ API Client │  │  Recorder  │  │  Interface │      │      │
│  │  └─────┬──────┘  └─────┬──────┘  └────────────┘      │      │
│  └────────┼───────────────┼─────────────────────────────┘      │
│           │               │                                     │
│           ▼               ▼                                     │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                   Sync Layer                          │      │
│  │  ┌────────────────────────────────────────────┐      │      │
│  │  │              Timeline Sync                  │      │      │
│  │  │  - Match events + Audio segments alignment  │      │      │
│  │  │  - Event-Audio linking                      │      │      │
│  │  └────────────────────────────────────────────┘      │      │
│  └──────────────────────┬───────────────────────────────┘      │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                  Service Layer                        │      │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐  │      │
│  │  │  Match   │ │  Stats   │ │  Team    │ │   AI    │  │      │
│  │  │ Tracker  │ │ Service  │ │ Service  │ │  Coach  │  │      │
│  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘  │      │
│  └──────────────────────┬───────────────────────────────┘      │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                   Data Layer                          │      │
│  │  ┌────────────────┐    ┌────────────────────────┐    │      │
│  │  │   SQLite DB    │    │   Audio Files (.wav)   │    │      │
│  │  │  (SQLAlchemy)  │    │   /data/recordings/    │    │      │
│  │  └────────────────┘    └────────────────────────┘    │      │
│  └──────────────────────────────────────────────────────┘      │
│                         │                                       │
│                         ▼                                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                    UI Layer                           │      │
│  │  ┌──────────────┐    ┌──────────────────────────┐    │      │
│  │  │  Streamlit   │    │   2D Replay Player       │    │      │
│  │  │  Dashboard   │    │   (with VC sync)         │    │      │
│  │  └──────────────┘    └──────────────────────────┘    │      │
│  └──────────────────────────────────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 コンポーネント詳細

#### Valorant API Client
- Valorantローカルクライアントとの通信
- ロックファイル読み取り、認証
- WebSocketによるリアルタイムイベント購読
- REST APIによるマッチ詳細取得

#### Audio Recorder
- システム音声のキャプチャ
- ラウンド単位でのファイル分割
- 録音開始/停止のトリガー管理

#### Timeline Sync
- マッチ開始時刻を基準とした統一タイムライン
- イベントと音声セグメントの紐付け
- 双方向インデックス（イベント→音声、音声→イベント）

#### Match Tracker Service
- ゲーム状態の監視
- マッチ/ラウンドイベントの処理
- 録音サービスとの連携

#### Stats Service
- 統計データの集計・計算
- マップ別、エージェント別、時間帯別の分析

#### Team Service
- チーム/メンバー管理
- スクリム自動検出

#### AI Coach
- LLMによるコミュニケーション評価
- RAGナレッジベースの管理

---

## 5. データモデル

### 5.1 ER図

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     matches     │     │     rounds      │     │     kills       │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ match_id (PK)   │────<│ id (PK)         │────<│ id (PK)         │
│ map_id          │     │ match_id (FK)   │     │ round_id (FK)   │
│ map_name        │     │ round_number    │     │ game_time       │
│ start_time      │     │ result          │     │ killer_puuid    │
│ end_time        │     │ win_condition   │     │ victim_puuid    │
│ ally_score      │     │ economy_tag     │     │ location_x      │
│ enemy_score     │     │ start_offset    │     │ location_y      │
│ team_id (FK)    │     │ end_offset      │     │ weapon_id       │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                │
                                │
┌─────────────────┐     ┌───────┴─────────┐     ┌─────────────────┐
│ audio_segments  │     │ event_audio_    │     │   transcripts   │
├─────────────────┤     │    links        │     ├─────────────────┤
│ id (PK)         │────<├─────────────────┤>────│ id (PK)         │
│ match_id (FK)   │     │ id (PK)         │     │ segment_id (FK) │
│ round_number    │     │ event_type      │     │ time_offset     │
│ file_path       │     │ event_id        │     │ speaker_id      │
│ start_offset    │     │ segment_id (FK) │     │ content         │
│ end_offset      │     │ audio_start     │     │ sentiment       │
│ duration        │     │ audio_end       │     │ is_useful       │
└─────────────────┘     └─────────────────┘     └─────────────────┘

┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│     teams       │     │  team_members   │     │    players      │
├─────────────────┤     ├─────────────────┤     ├─────────────────┤
│ id (PK)         │────<│ id (PK)         │>────│ puuid (PK)      │
│ name            │     │ team_id (FK)    │     │ player_name     │
│ tag             │     │ puuid (FK)      │     │ tag_line        │
│ created_at      │     │ role            │     │ last_seen       │
└─────────────────┘     └─────────────────┘     └─────────────────┘

┌─────────────────┐     ┌─────────────────┐
│ player_stats    │     │  ai_feedback    │
├─────────────────┤     ├─────────────────┤
│ id (PK)         │     │ id (PK)         │
│ match_id (FK)   │     │ round_id (FK)   │
│ puuid (FK)      │     │ summary         │
│ kills           │     │ score           │
│ deaths          │     │ improvements    │
│ assists         │     │ highlights      │
│ damage_dealt    │     │ created_at      │
│ headshots       │     └─────────────────┘
│ first_bloods    │
└─────────────────┘
```

### 5.2 主要テーブル定義

#### matches（試合）
| カラム | 型 | 説明 |
|--------|------|------|
| match_id | VARCHAR(36) PK | Valorant マッチID |
| map_id | VARCHAR(36) | マップID |
| map_name | VARCHAR(50) | マップ名 |
| start_time | DATETIME | 試合開始時刻 |
| end_time | DATETIME | 試合終了時刻 |
| ally_score | INTEGER | 味方スコア |
| enemy_score | INTEGER | 敵スコア |
| team_id | VARCHAR(36) FK | チームID（所属時） |

#### audio_segments（音声セグメント）
| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER PK | セグメントID |
| match_id | VARCHAR(36) FK | マッチID |
| round_number | INTEGER | ラウンド番号 |
| file_path | VARCHAR(255) | 音声ファイルパス |
| start_offset | FLOAT | マッチ開始からのオフセット（秒） |
| end_offset | FLOAT | マッチ開始からの終了オフセット |
| duration | FLOAT | 長さ（秒） |

#### event_audio_links（イベント-音声リンク）
| カラム | 型 | 説明 |
|--------|------|------|
| id | INTEGER PK | リンクID |
| event_type | VARCHAR(20) | イベント種別（kill/plant/defuse） |
| event_id | INTEGER | イベントID |
| segment_id | INTEGER FK | 音声セグメントID |
| audio_start | FLOAT | 音声内の開始位置（秒） |
| audio_end | FLOAT | 音声内の終了位置（秒） |

---

## 6. 画面設計

### 6.1 ダッシュボード画面

```
┌────────────────────────────────────────────────────────────────┐
│  Valorant Tracker                          [Settings] [User]   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─ Recent Matches ──────────────────────────────────────────┐ │
│  │                                                           │ │
│  │  ┌────────┬──────────┬─────────┬──────────┬────────────┐ │ │
│  │  │ Date   │ Map      │ Score   │ Team     │ Actions    │ │ │
│  │  ├────────┼──────────┼─────────┼──────────┼────────────┤ │ │
│  │  │ 12/11  │ Ascent   │ 13-7 W  │ MyTeam   │ [詳細][▶]  │ │ │
│  │  │ 12/10  │ Haven    │ 11-13 L │ MyTeam   │ [詳細][▶]  │ │ │
│  │  │ 12/10  │ Bind     │ 13-10 W │ MyTeam   │ [詳細][▶]  │ │ │
│  │  └────────┴──────────┴─────────┴──────────┴────────────┘ │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                │
│  ┌─ Statistics ─────────────┐  ┌─ Recording Status ─────────┐ │
│  │                          │  │                            │ │
│  │  Win Rate: 65%           │  │  Status: ● Recording       │ │
│  │  Avg ACS: 245            │  │  Match: abc123...          │ │
│  │  K/D: 1.2                │  │  Round: 5                  │ │
│  │                          │  │  Duration: 12:34           │ │
│  └──────────────────────────┘  └────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 6.2 2Dリプレイ画面

```
┌────────────────────────────────────────────────────────────────┐
│  2D Replay - Ascent | Round 5 | 13-7 W                  [✕]   │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │                                                          │ │
│  │                    [2D マップ表示]                       │ │
│  │                                                          │ │
│  │       ●A          プレイヤーアイコン                     │ │
│  │        \           (味方: 青, 敵: 赤)                    │ │
│  │         ●B                                               │ │
│  │        / \         × キルポイント                        │ │
│  │       ●C  ●D                                             │ │
│  │                                                          │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  Timeline:                                                     │
│  ├─●──────○──────○──────○──────────────────────────────────▶ │
│  0:00    0:15   0:30   0:45    1:00    1:15    1:30           │
│          ↑Kill  ↑Kill         ↑Plant                          │
│                                                                │
│  ┌─ Voice Chat ─────────────────────────────────────────────┐ │
│  │  [0:12] Player1: "ショート来てる！"                      │ │
│  │  [0:14] Player2: "OK、カバー行く"     ◀ 再生中          │ │
│  │  [0:28] Player3: "A詰めよう"                             │ │
│  │  [0:45] Player1: "設置するわ"                            │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  [◀◀] [▶ Play] [▶▶]  🔊 ────●──── 100%  [Round ▼] [Export]  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 7. 開発フェーズ

### Phase 1: 基盤構築（1週間）
- [ ] プロジェクト構成、依存関係セットアップ
- [ ] DBスキーマ設計・実装（SQLAlchemy）
- [ ] comms_trackerコードの移植

### Phase 2: Valorant API連携（1週間）
- [ ] ローカルAPI接続機能
- [ ] WebSocketイベント購読
- [ ] マッチトラッキングサービス

### Phase 3: マッチ-VC同期（1.5週間）
- [ ] 同期録音システム
- [ ] タイムライン同期レイヤー
- [ ] イベント-音声紐付け

### Phase 4: 統計・チーム管理（1週間）
- [ ] プレイヤー統計機能
- [ ] チーム管理機能

### Phase 5: 2Dリプレイ（1.5週間）
- [ ] 2Dマップ表示
- [ ] タイムライン再生
- [ ] VC同期プレイヤー

### Phase 6: AI評価・UI統合（1週間）
- [ ] AI評価機能の移植
- [ ] Streamlitダッシュボード統合
- [ ] テスト・バグ修正

---

## 8. 技術スタック

| カテゴリ | 技術 |
|---------|------|
| 言語 | Python 3.10+ |
| DB | SQLite + SQLAlchemy |
| Valorant API | valorant.py / 自前実装 |
| 音声録音 | sounddevice + soundfile |
| 音声認識 | Faster-Whisper |
| 話者識別 | Pyannote |
| AI/LLM | LM Studio + llama |
| 非同期処理 | asyncio + aiohttp |
| UI | Streamlit |
| テスト | pytest |

---

## 9. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Valorant API変更 | 高 | APIバージョン管理、抽象化レイヤー |
| 音声認識精度 | 中 | Valorant用語辞書の継続的改善 |
| パフォーマンス | 中 | 非同期処理、バッチ処理の活用 |
| ストレージ容量 | 低 | 音声ファイルの圧縮、古いデータの自動削除 |

---

## 10. 環境設定

### 環境変数一覧

```env
# Audio Settings
AUDIO_DEVICE_NAME=           # 音声入力デバイス名（空=デフォルト）
AUDIO_SAMPLE_RATE=16000      # サンプルレート

# Whisper (Speech Recognition)
WHISPER_MODEL=base           # モデルサイズ: tiny, base, small, medium, large
WHISPER_DEVICE=cuda          # 推論デバイス: cuda, cpu
WHISPER_COMPUTE_TYPE=float16 # 計算精度: float16, int8, float32

# LM Studio (AI Coach)
LM_STUDIO_URL=http://localhost:1234/v1
LM_STUDIO_MODEL=llama-3.1-8b-instruct

# DeepSeek API (Vision Analysis)
DEEPSEEK_API_KEY=            # APIキー（オプション）
DEEPSEEK_API_URL=https://api.deepseek.com/v1

# Database
DATABASE_PATH=data/valorant_tracker.db

# Output
RECORDINGS_DIR=data/recordings
OUTPUT_DIR=data/output

# Logging
LOG_LEVEL=INFO               # DEBUG, INFO, WARNING, ERROR
```

---

## 11. 将来的な拡張

- KPIアプリへの統合（目標管理との連携）
- React UIへの移行
- クラウドデプロイ対応
- 複数チーム対応
- 試合VODとの同期機能

